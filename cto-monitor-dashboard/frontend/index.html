<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTO Monitor Dashboard - Tempo Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .task-card {
            transition: all 0.3s ease;
        }
        .task-card:hover {
            transform: translateY(-4px);
        }
        .dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-white/20 backdrop-blur-sm rounded-lg p-3">
                        <i data-lucide="activity" class="w-8 h-8 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white">CTO Monitor Dashboard</h1>
                        <p class="text-purple-100">Monitoramento em Tempo Real das Tarefas</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="themeToggle" class="bg-white/20 backdrop-blur-sm text-white p-3 rounded-lg hover:bg-white/30 transition">
                        <i data-lucide="moon" class="w-5 h-5"></i>
                    </button>
                    <div id="connectionStatus" class="bg-yellow-500 text-white px-4 py-2 rounded-full flex items-center space-x-2">
                        <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
                        <span class="font-medium">Conectando...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Stats Cards -->
    <div class="container mx-auto px-4 -mt-8 relative z-10">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Total Tasks -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 task-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total de Tarefas</p>
                        <p id="totalTasks" class="text-3xl font-bold text-gray-900 dark:text-white mt-1">0</p>
                        <p class="text-xs text-gray-400 mt-1">No sistema</p>
                    </div>
                    <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-lg">
                        <i data-lucide="layers" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
                    </div>
                </div>
            </div>

            <!-- Running Tasks -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 task-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">⏳ Em Execução</p>
                        <p id="runningTasks" class="text-3xl font-bold text-orange-600 dark:text-orange-400 mt-1">0</p>
                        <p class="text-xs text-gray-400 mt-1">Processando agora</p>
                    </div>
                    <div class="bg-orange-100 dark:bg-orange-900 p-3 rounded-lg">
                        <i data-lucide="loader" class="w-6 h-6 text-orange-600 dark:text-orange-400 animate-spin-slow"></i>
                    </div>
                </div>
            </div>

            <!-- Completed Tasks -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 task-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">✅ Concluídas</p>
                        <p id="completedTasks" class="text-3xl font-bold text-green-600 dark:text-green-400 mt-1">0</p>
                        <p class="text-xs text-gray-400 mt-1">Com sucesso</p>
                    </div>
                    <div class="bg-green-100 dark:bg-green-900 p-3 rounded-lg">
                        <i data-lucide="check-circle" class="w-6 h-6 text-green-600 dark:text-green-400"></i>
                    </div>
                </div>
            </div>

            <!-- Failed Tasks -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 task-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">❌ Falhadas</p>
                        <p id="failedTasks" class="text-3xl font-bold text-red-600 dark:text-red-400 mt-1">0</p>
                        <p class="text-xs text-gray-400 mt-1">Com erro</p>
                    </div>
                    <div class="bg-red-100 dark:bg-red-900 p-3 rounded-lg">
                        <i data-lucide="x-circle" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 mt-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Tasks List -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Tarefas Ativas</h2>
                            <button id="refreshBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition flex items-center space-x-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                <span>Atualizar</span>
                            </button>
                        </div>
                    </div>
                    <div id="tasksList" class="p-6 space-y-4 max-h-[600px] overflow-y-auto">
                        <!-- Tasks will be inserted here -->
                        <div class="text-center py-8 text-gray-400">
                            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4"></i>
                            <p>Aguardando tarefas...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Feed -->
            <div>
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white">Feed de Atividades</h2>
                    </div>
                    <div id="activityFeed" class="p-6 space-y-3 max-h-[600px] overflow-y-auto">
                        <!-- Activities will be inserted here -->
                        <div class="text-center py-8 text-gray-400">
                            <i data-lucide="activity" class="w-12 h-12 mx-auto mb-4"></i>
                            <p>Sem atividades recentes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="fixed bottom-4 right-4 transform translate-x-full transition-transform duration-300">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-4 flex items-center space-x-3 min-w-[320px]">
            <div id="notificationIcon" class="flex-shrink-0"></div>
            <div class="flex-1">
                <p id="notificationTitle" class="font-semibold text-gray-900 dark:text-white"></p>
                <p id="notificationMessage" class="text-sm text-gray-600 dark:text-gray-400"></p>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        let ws = null;
        let reconnectInterval = null;
        const API_URL = 'http://localhost:8080';
        const WS_URL = 'ws://localhost:8080/ws';

        // State
        let tasks = [];
        let activities = [];

        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            if (document.body.classList.contains('dark')) {
                themeIcon.setAttribute('data-lucide', 'sun');
            } else {
                themeIcon.setAttribute('data-lucide', 'moon');
            }
            lucide.createIcons();
        });

        // Initialize Lucide icons
        lucide.createIcons();

        // Connect to WebSocket
        function connectWebSocket() {
            try {
                ws = new WebSocket(WS_URL);

                ws.onopen = () => {
                    console.log('WebSocket connected');
                    showNotification('success', 'Conectado', 'Conexão estabelecida com o servidor');
                    clearInterval(reconnectInterval);
                    
                    // Update connection status
                    updateConnectionStatus(true);
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    // Don't show error notification on initial connection attempts
                    updateConnectionStatus(false);
                };

                ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    updateConnectionStatus(false);
                    
                    // Try to reconnect after 5 seconds
                    if (!reconnectInterval) {
                        reconnectInterval = setInterval(() => {
                            connectWebSocket();
                        }, 5000);
                    }
                };
            } catch (error) {
                console.error('Failed to create WebSocket:', error);
                updateConnectionStatus(false);
            }
        }
        
        // Update connection status indicator
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                if (connected) {
                    statusEl.classList.remove('bg-yellow-500');
                    statusEl.classList.add('bg-green-500');
                    statusEl.querySelector('span').textContent = 'Conectado';
                } else {
                    statusEl.classList.remove('bg-green-500');
                    statusEl.classList.add('bg-yellow-500');
                    statusEl.querySelector('span').textContent = 'Reconectando...';
                }
            }
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'initial_state':
                    tasks = data.tasks || [];
                    updateUI();
                    break;
                case 'task_running':
                case 'task_completed':
                case 'task_failed':
                    addActivity(data.data);
                    fetchTasks();
                    break;
                case 'stats':
                    updateStats(data.data);
                    break;
            }
        }

        // Fetch tasks from API
        async function fetchTasks() {
            try {
                const response = await fetch(`${API_URL}/api/tasks`);
                const data = await response.json();
                tasks = data.tasks || [];
                updateUI();
            } catch (error) {
                console.error('Error fetching tasks:', error);
            }
        }

        // Update UI
        function updateUI() {
            updateStats();
            updateTasksList();
            lucide.createIcons();
        }

        // Update statistics
        function updateStats(stats = null) {
            if (!stats) {
                stats = {
                    total: tasks.length,
                    running: tasks.filter(t => t.status === 'running').length,
                    completed: tasks.filter(t => t.status === 'completed').length,
                    failed: tasks.filter(t => t.status === 'failed').length
                };
            }

            document.getElementById('totalTasks').textContent = stats.total || 0;
            document.getElementById('runningTasks').textContent = stats.running || 0;
            document.getElementById('completedTasks').textContent = stats.completed || 0;
            document.getElementById('failedTasks').textContent = stats.failed || 0;
        }

        // Update tasks list
        function updateTasksList() {
            const tasksList = document.getElementById('tasksList');
            
            if (tasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4"></i>
                        <p>Nenhuma tarefa encontrada</p>
                    </div>
                `;
                return;
            }

            tasksList.innerHTML = tasks.map(task => {
                const statusConfig = {
                    running: { color: 'orange', icon: 'loader', label: '⏳ Em Execução', emoji: '⏳', animate: 'animate-spin-slow' },
                    completed: { color: 'green', icon: 'check-circle', label: '✅ Concluída', emoji: '✅', animate: '' },
                    failed: { color: 'red', icon: 'x-circle', label: '❌ Falhou', emoji: '❌', animate: '' },
                    pending: { color: 'gray', icon: 'clock', label: '⏸️ Pendente', emoji: '⏸️', animate: '' }
                };

                const status = statusConfig[task.status] || statusConfig.pending;

                return `
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <div class="bg-${status.color}-100 dark:bg-${status.color}-900 p-1 rounded">
                                        <i data-lucide="${status.icon}" class="w-4 h-4 text-${status.color}-600 dark:text-${status.color}-400 ${status.animate}"></i>
                                    </div>
                                    <span class="font-semibold text-gray-900 dark:text-white">
                                        ${status.emoji} Task #${task.id}
                                    </span>
                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-${status.color}-100 dark:bg-${status.color}-900 text-${status.color}-700 dark:text-${status.color}-300">
                                        ${status.label}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                    ${task.message ? task.message.substring(0, 100) + '...' : 'Sem mensagem'}
                                </p>
                                <div class="flex items-center space-x-4 text-xs text-gray-500">
                                    <span class="flex items-center space-x-1">
                                        <i data-lucide="calendar" class="w-3 h-3"></i>
                                        <span>${new Date(task.created_at).toLocaleString('pt-BR')}</span>
                                    </span>
                                    ${task.identifier ? `<span class="flex items-center space-x-1">
                                        <i data-lucide="tag" class="w-3 h-3"></i>
                                        <span>${task.identifier}</span>
                                    </span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Add activity to feed
        function addActivity(data) {
            const activity = {
                timestamp: new Date().toLocaleTimeString('pt-BR'),
                ...data
            };

            activities.unshift(activity);
            if (activities.length > 10) {
                activities = activities.slice(0, 10);
            }

            updateActivityFeed();
        }

        // Update activity feed
        function updateActivityFeed() {
            const activityFeed = document.getElementById('activityFeed');
            
            if (activities.length === 0) {
                activityFeed.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i data-lucide="activity" class="w-12 h-12 mx-auto mb-4"></i>
                        <p>Sem atividades recentes</p>
                    </div>
                `;
                return;
            }

            activityFeed.innerHTML = activities.map(activity => {
                const iconConfig = {
                    completed: { icon: 'check-circle', color: 'green' },
                    failed: { icon: 'x-circle', color: 'red' },
                    running: { icon: 'play-circle', color: 'orange' }
                };

                const config = iconConfig[activity.status] || { icon: 'info', color: 'gray' };

                return `
                    <div class="flex items-start space-x-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        <div class="bg-${config.color}-100 dark:bg-${config.color}-900 p-2 rounded">
                            <i data-lucide="${config.icon}" class="w-4 h-4 text-${config.color}-600 dark:text-${config.color}-400"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900 dark:text-white">
                                Task #${activity.id} - ${activity.status}
                            </p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                ${activity.message || 'Status atualizado'}
                            </p>
                            <p class="text-xs text-gray-400 mt-1">
                                ${activity.timestamp}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }

        // Show notification toast
        function showNotification(type, title, message) {
            const toast = document.getElementById('notificationToast');
            const iconEl = document.getElementById('notificationIcon');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');

            const iconConfig = {
                success: { icon: 'check-circle', color: 'green' },
                error: { icon: 'x-circle', color: 'red' },
                warning: { icon: 'alert-triangle', color: 'yellow' }
            };

            const config = iconConfig[type] || iconConfig.warning;

            iconEl.innerHTML = `
                <div class="bg-${config.color}-100 dark:bg-${config.color}-900 p-2 rounded">
                    <i data-lucide="${config.icon}" class="w-5 h-5 text-${config.color}-600 dark:text-${config.color}-400"></i>
                </div>
            `;

            titleEl.textContent = title;
            messageEl.textContent = message;

            lucide.createIcons();

            // Show toast
            toast.classList.remove('translate-x-full');

            // Hide after 5 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 5000);
        }

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => {
            fetchTasks();
            showNotification('success', 'Atualizado', 'Dados atualizados com sucesso');
        });

        // Initialize
        // Start without WebSocket for now, just use polling
        fetchTasks();
        updateConnectionStatus(true); // Show as connected since API is working
        
        // Auto-refresh every 3 seconds
        setInterval(fetchTasks, 3000);
        
        // Try WebSocket connection (optional)
        setTimeout(() => {
            try {
                connectWebSocket();
            } catch (e) {
                console.log('WebSocket not available, using polling only');
            }
        }, 1000);
    </script>
</body>
</html>