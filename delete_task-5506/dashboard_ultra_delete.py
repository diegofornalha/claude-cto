#!/usr/bin/env python3
"""
Dashboard Delete Task ULTRA - Claude-CTO
Interface ultra-segura para remo√ß√£o de tarefas com dependency impact analysis,
confirmation workflow, safe delete (quarantine) e audit trail
"""

import streamlit as st
import requests
import json
import time
import plotly.graph_objects as go
import networkx as nx
from datetime import datetime, timedelta
from typing import Dict, List, Optional
import pandas as pd

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="Delete Task Ultra - Claude-CTO",
    page_icon="üóëÔ∏è",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS ultra-avan√ßado
st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    .main-header {
        font-size: 3rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 2rem;
        background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-family: 'Inter', sans-serif;
    }
    
    .danger-alert {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border: 2px solid #dc3545;
        border-radius: 15px;
        padding: 2rem;
        margin: 1rem 0;
        animation: pulse-warning 2s infinite;
    }
    
    .safe-delete {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 1px solid #ffc107;
        border-radius: 15px;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    
    .impact-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border-left: 5px solid;
    }
    
    .impact-critical { border-left-color: #dc3545; }
    .impact-warning { border-left-color: #ffc107; }
    .impact-safe { border-left-color: #28a745; }
    
    .quarantine-container {
        background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%);
        border: 2px dashed #6c757d;
        border-radius: 15px;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    
    .audit-trail {
        background: #000;
        color: #00ff00;
        padding: 1rem;
        border-radius: 10px;
        font-family: 'Courier New', monospace;
        margin: 1rem 0;
        max-height: 200px;
        overflow-y: auto;
    }
    
    @keyframes pulse-warning {
        0% { border-color: #dc3545; }
        50% { border-color: #ff6b6b; }
        100% { border-color: #dc3545; }
    }
    
    .confirmation-step {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: 2px solid #e9ecef;
    }
    
    .confirmation-step.active {
        border-color: #667eea;
        background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
    }
    
    .confirmation-step.completed {
        border-color: #28a745;
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    }
</style>
""", unsafe_allow_html=True)

class DependencyAnalyzer:
    """Analisador de impacto de depend√™ncias"""
    
    @staticmethod
    def analyze_dependency_impact(task_to_delete: str, all_tasks: List[Dict]) -> Dict:
        """Analisa impacto da remo√ß√£o na rede de depend√™ncias"""
        # Encontrar tarefas que dependem desta
        dependent_tasks = []
        for task in all_tasks:
            deps = task.get('depends_on', [])
            if task_to_delete in deps:
                dependent_tasks.append(task)
        
        # Encontrar depend√™ncias desta tarefa
        task_data = next((t for t in all_tasks if t.get('task_identifier') == task_to_delete), None)
        dependencies = task_data.get('depends_on', []) if task_data else []
        
        # Calcular n√≠vel de impacto
        total_affected = len(dependent_tasks)
        
        if total_affected == 0:
            impact_level = "SEGURO"
        elif total_affected <= 2:
            impact_level = "BAIXO"
        elif total_affected <= 5:
            impact_level = "M√âDIO"
        else:
            impact_level = "CR√çTICO"
        
        # Verificar se h√° tarefas em execu√ß√£o afetadas
        running_affected = [t for t in dependent_tasks if t.get('status') == 'running']
        
        return {
            'impact_level': impact_level,
            'dependent_tasks': dependent_tasks,
            'dependencies': dependencies,
            'total_affected': total_affected,
            'running_affected': running_affected,
            'task_data': task_data
        }
    
    @staticmethod
    def render_dependency_graph(task_to_delete: str, all_tasks: List[Dict]):
        """Renderiza grafo de depend√™ncias com destaque para impacto"""
        # Criar grafo
        G = nx.DiGraph()
        
        # Adicionar n√≥s
        for task in all_tasks:
            task_id = task.get('task_identifier', '')
            G.add_node(task_id, status=task.get('status', 'unknown'))
        
        # Adicionar arestas
        for task in all_tasks:
            task_id = task.get('task_identifier', '')
            for dep in task.get('depends_on', []):
                if dep in [t.get('task_identifier') for t in all_tasks]:
                    G.add_edge(dep, task_id)
        
        # Encontrar subgrafo relevante (tarefa + vizinhos)
        neighbors = set([task_to_delete])
        neighbors.update(G.predecessors(task_to_delete))
        neighbors.update(G.successors(task_to_delete))
        
        # Criar subgrafo
        subG = G.subgraph(neighbors)
        
        if len(subG.nodes()) == 0:
            st.info("üìä Tarefa n√£o possui depend√™ncias")
            return
        
        # Layout
        pos = nx.spring_layout(subG, k=2, iterations=50)
        
        # Criar figura Plotly
        fig = go.Figure()
        
        # Adicionar arestas
        edge_x, edge_y = [], []
        for edge in subG.edges():
            x0, y0 = pos[edge[0]]
            x1, y1 = pos[edge[1]]
            edge_x.extend([x0, x1, None])
            edge_y.extend([y0, y1, None])
        
        fig.add_trace(go.Scatter(
            x=edge_x, y=edge_y,
            line=dict(width=2, color='#666'),
            hoverinfo='none',
            mode='lines',
            name='Depend√™ncias'
        ))
        
        # Adicionar n√≥s com cores baseadas no impacto
        for node in subG.nodes():
            x, y = pos[node]
            
            if node == task_to_delete:
                color = '#dc3545'  # Vermelho para tarefa a ser deletada
                size = 30
                symbol = 'x'
            elif node in G.successors(task_to_delete):
                color = '#ffc107'  # Amarelo para tarefas afetadas
                size = 25
                symbol = 'circle'
            else:
                color = '#28a745'  # Verde para depend√™ncias
                size = 20
                symbol = 'circle'
            
            fig.add_trace(go.Scatter(
                x=[x], y=[y],
                mode='markers+text',
                marker=dict(size=size, color=color, symbol=symbol),
                text=[node[:10] + '...' if len(node) > 10 else node],
                textposition='bottom center',
                name=node,
                showlegend=False
            ))
        
        fig.update_layout(
            title="üï∏Ô∏è An√°lise de Impacto de Depend√™ncias",
            showlegend=False,
            height=400,
            xaxis=dict(showgrid=False, zeroline=False, showticklabels=False),
            yaxis=dict(showgrid=False, zeroline=False, showticklabels=False),
            plot_bgcolor='rgba(0,0,0,0)',
            paper_bgcolor='rgba(0,0,0,0)'
        )
        
        st.plotly_chart(fig, use_container_width=True)
        
        # Legenda
        st.markdown("""
        **üé® Legenda:**
        - üî¥ Tarefa a ser deletada
        - üü° Tarefas que ser√£o afetadas
        - üü¢ Depend√™ncias da tarefa
        """)

class AuditLogger:
    """Logger de auditoria para remo√ß√µes"""
    
    @staticmethod
    def log_deletion_attempt(task_id: str, user_info: Dict, impact_data: Dict) -> str:
        """Registra tentativa de dele√ß√£o"""
        log_entry = {
            'timestamp': datetime.now().isoformat(),
            'action': 'DELETE_ATTEMPT',
            'task_id': task_id,
            'user': user_info.get('user', 'unknown'),
            'impact_level': impact_data.get('impact_level'),
            'affected_tasks': len(impact_data.get('dependent_tasks', [])),
            'session_id': hash(str(datetime.now()))
        }
        
        return json.dumps(log_entry, indent=2)
    
    @staticmethod
    def log_deletion_success(task_id: str, execution_time: float) -> str:
        """Registra dele√ß√£o bem-sucedida"""
        log_entry = {
            'timestamp': datetime.now().isoformat(),
            'action': 'DELETE_SUCCESS',
            'task_id': task_id,
            'execution_time_ms': round(execution_time * 1000, 2),
            'session_id': hash(str(datetime.now()))
        }
        
        return json.dumps(log_entry, indent=2)

class DeleteTaskDashboard:
    def __init__(self):
        self.base_url = "http://localhost:8889/api/v1"
        self.dependency_analyzer = DependencyAnalyzer()
        self.audit_logger = AuditLogger()
        
        # Estado da aplica√ß√£o
        if 'selected_task_to_delete' not in st.session_state:
            st.session_state.selected_task_to_delete = None
        if 'confirmation_steps' not in st.session_state:
            st.session_state.confirmation_steps = {}
        if 'quarantine_mode' not in st.session_state:
            st.session_state.quarantine_mode = True
        if 'audit_logs' not in st.session_state:
            st.session_state.audit_logs = []
    
    def get_all_tasks(self) -> List[Dict]:
        """Obt√©m todas as tarefas"""
        try:
            response = requests.get(f"{self.base_url}/tasks", timeout=10)
            if response.status_code == 200:
                return response.json().get('tasks', [])
        except Exception:
            pass
        return []
    
    def delete_task(self, task_id: str, safe_mode: bool = True) -> bool:
        """Deleta uma tarefa (com modo seguro)"""
        try:
            endpoint = f"{self.base_url}/tasks/{task_id}"
            if safe_mode:
                endpoint += "?safe_delete=true"
            
            response = requests.delete(endpoint, timeout=30)
            return response.status_code == 200
        except Exception:
            return False
    
    def quarantine_task(self, task_id: str) -> bool:
        """Move tarefa para quarentena (soft delete)"""
        try:
            response = requests.patch(
                f"{self.base_url}/tasks/{task_id}/quarantine",
                timeout=30
            )
            return response.status_code == 200
        except Exception:
            return False
    
    def render_task_selector(self, tasks: List[Dict]) -> Optional[str]:
        """Renderiza seletor de tarefas para dele√ß√£o"""
        st.subheader("üéØ Selecionar Tarefa para Remo√ß√£o")
        
        if not tasks:
            st.warning("üì≠ Nenhuma tarefa dispon√≠vel para remo√ß√£o")
            return None
        
        # Filtrar apenas tarefas que podem ser deletadas
        deletable_tasks = [
            task for task in tasks 
            if task.get('status') in ['completed', 'failed', 'cancelled']
        ]
        
        if not deletable_tasks:
            st.warning("‚ö†Ô∏è Nenhuma tarefa pode ser removida. Apenas tarefas conclu√≠das, falhas ou canceladas podem ser deletadas.")
            return None
        
        # Grid de sele√ß√£o
        cols = st.columns(3)
        
        for i, task in enumerate(deletable_tasks):
            with cols[i % 3]:
                task_id = task.get('task_identifier', '')
                status = task.get('status', 'unknown')
                created = task.get('created_at', '')[:10] if task.get('created_at') else 'N/A'
                
                # Card da tarefa
                if st.button(
                    f"üóëÔ∏è {task_id}",
                    key=f"select_delete_{i}",
                    help=f"Status: {status} | Criado: {created}",
                    use_container_width=True
                ):
                    return task_id
                
                # Informa√ß√µes adicionais
                st.markdown(f"""
                <div style="font-size: 0.8rem; color: #6c757d; text-align: center;">
                    üìä {status}<br>
                    üìÖ {created}
                </div>
                """, unsafe_allow_html=True)
        
        return None
    
    def render_impact_analysis(self, task_to_delete: str, all_tasks: List[Dict]):
        """Renderiza an√°lise de impacto"""
        st.subheader("‚ö†Ô∏è An√°lise de Impacto")
        
        impact_data = self.dependency_analyzer.analyze_dependency_impact(task_to_delete, all_tasks)
        
        # N√≠vel de impacto principal
        impact_level = impact_data['impact_level']
        total_affected = impact_data['total_affected']
        
        impact_colors = {
            'SEGURO': '#28a745',
            'BAIXO': '#20c997',
            'M√âDIO': '#ffc107',
            'CR√çTICO': '#dc3545'
        }
        
        impact_color = impact_colors.get(impact_level, '#6c757d')
        impact_class = f"impact-{impact_level.lower()}" if impact_level.lower() in ['safe', 'warning', 'critical'] else "impact-warning"
        
        st.markdown(f"""
        <div class="{impact_class}">
            <div style="text-align: center;">
                <h2>‚ö†Ô∏è N√≠vel de Impacto: <span style="color: {impact_color}">{impact_level}</span></h2>
                <h3>üéØ {total_affected} tarefas ser√£o afetadas</h3>
            </div>
        </div>
        """, unsafe_allow_html=True)
        
        # Detalhes do impacto
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("**üìä Tarefas Dependentes:**")
            if impact_data['dependent_tasks']:
                for dep_task in impact_data['dependent_tasks']:
                    status = dep_task.get('status', 'unknown')
                    status_emoji = {
                        'pending': '‚è≥',
                        'running': 'üîÑ',
                        'completed': '‚úÖ',
                        'failed': '‚ùå'
                    }.get(status, '‚ùì')
                    
                    st.markdown(f"‚Ä¢ {status_emoji} {dep_task.get('task_identifier', 'N/A')}")
            else:
                st.success("‚úÖ Nenhuma tarefa depende desta")
        
        with col2:
            st.markdown("**üîó Depend√™ncias Desta Tarefa:**")
            if impact_data['dependencies']:
                for dep in impact_data['dependencies']:
                    st.markdown(f"‚Ä¢ üîó {dep}")
            else:
                st.info("‚ÑπÔ∏è Esta tarefa n√£o possui depend√™ncias")
        
        # Alertas especiais
        if impact_data['running_affected']:
            st.markdown("""
            <div class="danger-alert">
                <strong>üö® ATEN√á√ÉO: TAREFAS EM EXECU√á√ÉO AFETADAS</strong><br>
                Existem tarefas em execu√ß√£o que dependem desta tarefa.
                Remov√™-la pode causar falhas em execu√ß√µes ativas.
            </div>
            """, unsafe_allow_html=True)
        
        # Grafo de depend√™ncias
        if total_affected > 0 or impact_data['dependencies']:
            self.dependency_analyzer.render_dependency_graph(task_to_delete, all_tasks)
        
        return impact_data
    
    def render_safe_delete_options(self):
        """Renderiza op√ß√µes de dele√ß√£o segura"""
        st.subheader("üõ°Ô∏è Op√ß√µes de Seguran√ßa")
        
        with st.container():
            st.markdown('<div class="safe-delete">', unsafe_allow_html=True)
            
            col1, col2 = st.columns(2)
            
            with col1:
                quarantine_mode = st.checkbox(
                    "üóÇÔ∏è Modo Quarentena",
                    value=st.session_state.quarantine_mode,
                    help="Move para quarentena em vez de deletar permanentemente"
                )
                st.session_state.quarantine_mode = quarantine_mode
                
                if quarantine_mode:
                    quarantine_days = st.number_input(
                        "Dias na quarentena:",
                        min_value=1,
                        max_value=90,
                        value=30,
                        help="Ap√≥s este per√≠odo, ser√° deletada automaticamente"
                    )
                    
                    st.info("üí° Modo quarentena permite recupera√ß√£o posterior")
            
            with col2:
                create_backup = st.checkbox(
                    "üíæ Criar backup antes da remo√ß√£o",
                    value=True,
                    help="Backup individual da tarefa"
                )
                
                if create_backup:
                    backup_format = st.selectbox(
                        "Formato do backup:",
                        ["JSON", "TXT"],
                        help="Formato do arquivo de backup"
                    )
                
                audit_trail = st.checkbox(
                    "üìã Registrar em audit trail",
                    value=True,
                    help="Manter registro da opera√ß√£o"
                )
            
            st.markdown('</div>', unsafe_allow_html=True)
        
        return {
            'quarantine_mode': quarantine_mode,
            'quarantine_days': quarantine_days if quarantine_mode else None,
            'create_backup': create_backup,
            'backup_format': backup_format if create_backup else None,
            'audit_trail': audit_trail
        }
    
    def render_confirmation_workflow(self, task_id: str, impact_data: Dict, safety_options: Dict):
        """Renderiza workflow de confirma√ß√£o em m√∫ltiplas etapas"""
        st.subheader("‚úÖ Confirma√ß√£o de Remo√ß√£o")
        
        steps_completed = 0
        total_steps = 3 if impact_data['impact_level'] != 'CR√çTICO' else 4
        
        # Etapa 1: Confirma√ß√£o b√°sica
        step1_class = "confirmation-step active" if steps_completed == 0 else "confirmation-step completed"
        
        st.markdown(f"""
        <div class="{step1_class}">
            <h4>üìã Etapa 1: Confirma√ß√£o B√°sica</h4>
        </div>
        """, unsafe_allow_html=True)
        
        confirm_basic = st.checkbox(
            f"üîç Confirmo que quero remover a tarefa '{task_id}'",
            help="Confirma√ß√£o b√°sica da inten√ß√£o"
        )
        
        if confirm_basic:
            steps_completed = 1
        else:
            return False, steps_completed
        
        # Etapa 2: Confirma√ß√£o de impacto
        step2_class = "confirmation-step active" if steps_completed == 1 else "confirmation-step completed"
        
        st.markdown(f"""
        <div class="{step2_class}">
            <h4>‚ö†Ô∏è Etapa 2: Confirma√ß√£o de Impacto</h4>
        </div>
        """, unsafe_allow_html=True)
        
        impact_text = f"Li e compreendi que {impact_data['total_affected']} tarefas ser√£o afetadas"
        if impact_data['running_affected']:
            impact_text += f" (incluindo {len(impact_data['running_affected'])} em execu√ß√£o)"
        
        confirm_impact = st.checkbox(
            f"üìä {impact_text}",
            help="Confirma√ß√£o do entendimento do impacto"
        )
        
        if confirm_impact:
            steps_completed = 2
        else:
            return False, steps_completed
        
        # Etapa 3: Confirma√ß√£o de seguran√ßa (apenas para cr√≠tico)
        if impact_data['impact_level'] == 'CR√çTICO':
            step3_class = "confirmation-step active" if steps_completed == 2 else "confirmation-step completed"
            
            st.markdown(f"""
            <div class="{step3_class}">
                <h4>üö® Etapa 3: Confirma√ß√£o de Alto Risco</h4>
            </div>
            """, unsafe_allow_html=True)
            
            confirm_critical = st.checkbox(
                "üö® Entendo que esta √© uma opera√ß√£o de ALTO RISCO",
                help="Confirma√ß√£o obrigat√≥ria para opera√ß√µes cr√≠ticas"
            )
            
            if confirm_critical:
                steps_completed = 3
            else:
                return False, steps_completed
        
        # Etapa final: Confirma√ß√£o textual
        final_step = total_steps - 1
        step_final_class = "confirmation-step active" if steps_completed == final_step else "confirmation-step"
        
        st.markdown(f"""
        <div class="{step_final_class}">
            <h4>‚úçÔ∏è Etapa Final: Confirma√ß√£o Textual</h4>
        </div>
        """, unsafe_allow_html=True)
        
        confirmation_text = "DELETAR" if not safety_options['quarantine_mode'] else "QUARENTENA"
        
        final_confirmation = st.text_input(
            f"Digite '{confirmation_text}' para confirmar:",
            placeholder=confirmation_text,
            help="Confirma√ß√£o final obrigat√≥ria"
        )
        
        if final_confirmation.upper() == confirmation_text:
            steps_completed = total_steps
            return True, steps_completed
        
        return False, steps_completed
    
    def render_audit_trail(self):
        """Renderiza trail de auditoria"""
        st.subheader("üìã Audit Trail")
        
        # Simular logs de auditoria
        audit_logs = [
            "[14:30:15] DELETE_ATTEMPT: task_analyze_auth_0830 - Impact: BAIXO - Affected: 1",
            "[14:30:20] DELETE_SUCCESS: task_analyze_auth_0830 - Duration: 1.2s",
            "[14:25:10] QUARANTINE: task_old_feature_0825 - Mode: SAFE - Days: 30",
            "[14:20:05] DELETE_ATTEMPT: task_bugfix_mem_0829 - Impact: M√âDIO - Affected: 3",
            "[14:20:08] DELETE_CANCELLED: task_bugfix_mem_0829 - Reason: USER_ABORT"
        ]
        
        st.markdown("""
        <div class="audit-trail">
            <pre>""" + "\\n".join(audit_logs) + """</pre>
        </div>
        """, unsafe_allow_html=True)
    
    def run_dashboard(self):
        """Interface principal do dashboard"""
        # Cabe√ßalho
        st.markdown('<h1 class="main-header">üóëÔ∏è Remo√ß√£o Segura de Tarefas</h1>', unsafe_allow_html=True)
        
        # Obter todas as tarefas
        all_tasks = self.get_all_tasks()
        
        if not all_tasks:
            st.markdown("""
            <div class="safe-zone">
                <strong>üì≠ Nenhuma tarefa encontrada</strong><br>
                N√£o h√° tarefas dispon√≠veis para remo√ß√£o.
            </div>
            """, unsafe_allow_html=True)
            return
        
        # Seletor de tarefa
        selected_task_id = self.render_task_selector(all_tasks)
        
        if selected_task_id:
            st.session_state.selected_task_to_delete = selected_task_id
        
        if not st.session_state.selected_task_to_delete:
            st.info("üëÜ Selecione uma tarefa acima para iniciar o processo de remo√ß√£o")
            return
        
        task_to_delete = st.session_state.selected_task_to_delete
        
        # An√°lise de impacto
        impact_data = self.render_impact_analysis(task_to_delete, all_tasks)
        
        # Op√ß√µes de seguran√ßa
        safety_options = self.render_safe_delete_options()
        
        # Workflow de confirma√ß√£o
        st.markdown("---")
        confirmed, steps_completed = self.render_confirmation_workflow(
            task_to_delete, impact_data, safety_options
        )
        
        # Barra de progresso das confirma√ß√µes
        total_steps = 3 if impact_data['impact_level'] != 'CR√çTICO' else 4
        progress = steps_completed / total_steps
        
        st.progress(progress)
        st.markdown(f"""
        <div style="text-align: center; color: #6c757d; margin: 0.5rem 0;">
            üìä Progresso da Confirma√ß√£o: {steps_completed}/{total_steps} etapas
        </div>
        """, unsafe_allow_html=True)
        
        # Executar remo√ß√£o se confirmado
        if confirmed:
            col1, col2 = st.columns(2)
            
            with col1:
                action_text = "üóÇÔ∏è Mover para Quarentena" if safety_options['quarantine_mode'] else "üóëÔ∏è Deletar Permanentemente"
                
                if st.button(action_text, use_container_width=True, type="primary"):
                    # Log da tentativa
                    if safety_options['audit_trail']:
                        attempt_log = self.audit_logger.log_deletion_attempt(
                            task_to_delete, {'user': 'current_user'}, impact_data
                        )
                        st.session_state.audit_logs.append(attempt_log)
                    
                    # Executar opera√ß√£o
                    start_time = time.time()
                    
                    with st.spinner(f"üîÑ {'Movendo para quarentena' if safety_options['quarantine_mode'] else 'Deletando tarefa'}..."):
                        if safety_options['quarantine_mode']:
                            success = self.quarantine_task(task_to_delete)
                        else:
                            success = self.delete_task(task_to_delete, True)
                        
                        execution_time = time.time() - start_time
                    
                    if success:
                        # Log de sucesso
                        if safety_options['audit_trail']:
                            success_log = self.audit_logger.log_deletion_success(task_to_delete, execution_time)
                            st.session_state.audit_logs.append(success_log)
                        
                        action_past = "movida para quarentena" if safety_options['quarantine_mode'] else "deletada"
                        
                        st.markdown(f"""
                        <div class="safe-zone">
                            <strong>‚úÖ Opera√ß√£o conclu√≠da com sucesso!</strong><br>
                            Tarefa '{task_to_delete}' foi {action_past}.<br>
                            ‚è±Ô∏è Tempo de execu√ß√£o: {execution_time:.2f}s
                        </div>
                        """, unsafe_allow_html=True)
                        
                        # Resetar estado
                        st.session_state.selected_task_to_delete = None
                        st.session_state.confirmation_steps = {}
                        
                        if st.button("üîÑ Atualizar Dashboard"):
                            st.rerun()
                    else:
                        st.error("‚ùå Erro ao executar opera√ß√£o. Tente novamente.")
            
            with col2:
                if st.button("‚ùå Cancelar Opera√ß√£o", use_container_width=True):
                    st.session_state.selected_task_to_delete = None
                    st.session_state.confirmation_steps = {}
                    st.rerun()
        
        # Audit trail
        st.markdown("---")
        self.render_audit_trail()
        
        # Sidebar com informa√ß√µes
        with st.sidebar:
            st.subheader("üìä Estat√≠sticas de Remo√ß√£o")
            
            # Contagem por status
            status_counts = {}
            for task in all_tasks:
                status = task.get('status', 'unknown')
                status_counts[status] = status_counts.get(status, 0) + 1
            
            deletable_count = sum([
                status_counts.get('completed', 0),
                status_counts.get('failed', 0),
                status_counts.get('cancelled', 0)
            ])
            
            st.metric("üóëÔ∏è Tarefas Remov√≠veis", deletable_count)
            st.metric("üîí Tarefas Protegidas", len(all_tasks) - deletable_count)
            
            if st.session_state.selected_task_to_delete:
                st.metric("üéØ Tarefa Selecionada", "1")
            
            st.markdown("---")
            
            # Configura√ß√µes r√°pidas
            st.subheader("‚öôÔ∏è Configura√ß√µes")
            
            # Modo de seguran√ßa global
            global_safe_mode = st.checkbox(
                "üõ°Ô∏è Modo Seguran√ßa Global",
                value=True,
                help="Ativa todas as prote√ß√µes por padr√£o"
            )
            
            if global_safe_mode:
                st.success("‚úÖ Todas as prote√ß√µes ativas")
            else:
                st.warning("‚ö†Ô∏è Modo avan√ßado - Cuidado!")
            
            # Estat√≠sticas de quarentena
            st.markdown("---")
            st.subheader("üóÇÔ∏è Quarentena")
            
            # Simular estat√≠sticas de quarentena
            quarantine_stats = {
                'items': 5,
                'oldest': '2024-08-25',
                'size': '12.5 MB'
            }
            
            st.metric("üì¶ Itens na Quarentena", quarantine_stats['items'])
            st.text(f"üìÖ Mais antiga: {quarantine_stats['oldest']}")
            st.text(f"üíΩ Tamanho: {quarantine_stats['size']}")
            
            if st.button("üßπ Limpar Quarentena", use_container_width=True):
                st.info("Limpando itens expirados da quarentena...")
            
            # A√ß√µes r√°pidas
            st.markdown("---")
            st.subheader("‚ö° A√ß√µes R√°pidas")
            
            if st.button("üìã Ver Todas Tarefas", use_container_width=True):
                st.info("Redirecionando para List Tasks...")
            
            if st.button("üßπ Limpeza em Lote", use_container_width=True):
                st.info("Redirecionando para Clear Tasks...")

def main():
    """Fun√ß√£o principal"""
    dashboard = DeleteTaskDashboard()
    dashboard.run_dashboard()

if __name__ == "__main__":
    main()